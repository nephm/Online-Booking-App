<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Badminton Court Booking</title>
    <link th:href="@{/css/styles.css}" rel="stylesheet">
    <link th:href="@{/css/court.css}" rel="stylesheet">
    <script th:src="@{/js/script.js}" defer></script>
</head>
<body>
<div class="dashboard-container">
    <header class="header">
        <nav class="nav">
            <div class="logo">CourtBooker</div>
            <div class="nav-links">
                <a th:href="@{/venues}" class="nav-link">Venues</a>
                <a th:href="@{/admin}" class="nav-link">Admin</a>
                <a th:href="@{/about}" class="nav-link">About</a>
                <a th:href="@{/contacts}" class="nav-link">Contacts</a>
                 <div class="profile">
                    <button class="profile-btn" onclick="window.location.href='/profile'">
                        <img src="images/userProfile_logo.jpg" alt="User icon" class="icon">
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <h1 class="venues-title" th:text="${pageTitle ?: 'Elite Badminton Center'}">Elite Badminton Center</h1>

    <!-- Edit Mode Notice -->
    <div th:if="${editMode}" class="edit-notice">
        <div class="edit-notice-content">
            <span class="edit-icon">✏️</span>
            <strong>Edit Mode:</strong> Select a new time slot for Booking #<span th:text="${editBookingId}"></span>
            <br><small>Original slot: <span th:text="${originalDate}"></span></small>
        </div>
    </div>

    <!-- Error/Success Messages -->
    <div th:if="${error}" class="alert alert-error" th:text="${error}" style="margin: 20px; padding: 15px; background: #fee; border: 1px solid #fcc; border-radius: 5px; color: #c00;"></div>
    <div th:if="${success}" class="alert alert-success" th:text="${success}" style="margin: 20px; padding: 15px; background: #efe; border: 1px solid #cfc; border-radius: 5px; color: #0a0;"></div>

    <!-- Date Filter -->
    <form method="get" th:action="@{/venue/__${venue.venueId}__/courts}" class="date-filter-container">
        <label for="date" class="date-filter-label">Select Date:</label>
        <select id="date" name="date" class="date-select" onchange="this.form.submit()">
            <option th:each="dateOption : ${availableDates}"
                    th:value="${dateOption}"
                    th:text="${#temporals.format(dateOption, 'MMM dd, yyyy')}"
                    th:selected="${dateOption.equals(selectedDate)}">
            </option>
        </select>
        <!-- Keep edit params in date filter -->
        <input th:if="${editBookingId}" type="hidden" name="editBookingId" th:value="${editBookingId}">
        <input th:if="${originalCourtId}" type="hidden" name="originalCourtId" th:value="${originalCourtId}">
        <input th:if="${originalTimeslotId}" type="hidden" name="originalTimeslotId" th:value="${originalTimeslotId}">
        <input th:if="${originalUserId}" type="hidden" name="originalUserId" th:value="${originalUserId}">
    </form>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color legend-available"></div>
            <span>Available</span>
        </div>
        <div class="legend-item">
            <div class="legend-color legend-selected"></div>
            <span>Selected</span>
        </div>
        <div class="legend-item">
            <div class="legend-color legend-booked"></div>
            <span>Booked</span>
        </div>
    </div>

    <!-- Booking table -->
    <form th:action="${submitAction ?: '/book'}" method="post">
        <!-- Hidden fields for edit mode -->
        <input th:if="${editMode}" type="hidden" name="editBookingId" th:value="${editBookingId}">
        <input th:if="${editMode}" type="hidden" name="originalUserId" th:value="${originalUserId}">
        
        <table id="bookingTable">
            <thead>
                <tr>
                    <th>Court</th>
                    <th th:each="slot : ${headerSlots}" th:text="${slot}"></th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="court : ${courts}">
                    <td class="court-label">
                        <span th:text="${court.courtName}"></span>
                    </td>
    
                    <td th:each="slot : ${timeSlots}" th:with="slotKey=${court.courtId + '-' + slot.timeslotId}">
                        <input type="checkbox"
                            name="selectedSlots"
                            th:value="${slotKey + '-' + #temporals.format(selectedDate, 'yyyy-MM-dd')}"
                            th:disabled="${availability.get(slotKey) == null || availability.get(slotKey) == false}" 
                            th:checked="${editMode && preSelectedSlot != null && preSelectedSlot.equals(slotKey)}"
                            class="timeslot-block"/>
                    </td>
                </tr>
            </tbody>
        </table>
    
        <div style="margin-top: 20px; text-align: center;">
            <button type="submit" class="proceed-btn" th:text="${submitButtonText ?: 'Proceed to Book'}">Proceed to Book</button>
            <a th:if="${editMode}" th:href="@{/admin}" class="proceed-btn" style="background: #6b7280; margin-left: 10px; text-decoration: none; display: inline-block;">Cancel</a>
        </div>
    </form>
</div>
</body>
</html>